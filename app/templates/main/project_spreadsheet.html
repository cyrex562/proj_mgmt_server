{% extends "base.html" %}

{% block content %}
<style>
.editable-cell {
    cursor: pointer;
    position: relative;
}

.editable-cell:hover {
    background-color: #f8f9fa;
}

.editable-cell .cell-content {
    display: block;
}

.editable-cell .form-control,
.editable-cell .form-select {
    border: 2px solid #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.editable-cell .form-control:focus,
.editable-cell .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.table td {
    vertical-align: middle;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Progress editing styles */
.progress {
    cursor: pointer;
    transition: all 0.2s ease;
}

.progress:hover {
    transform: scale(1.02);
}

.form-range {
    cursor: pointer;
}

.form-range::-webkit-slider-thumb {
    background: #007bff;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.form-range::-moz-range-thumb {
    background: #007bff;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ project.name }} - Spreadsheet View</h2>
    <div>
        <a href="{{ url_for('main.project_detail', project_id=project.id) }}" class="btn btn-outline-primary me-2">
            <i class="bi bi-eye"></i> View
        </a>
        <a href="{{ url_for('main.project_board', project_id=project.id) }}" class="btn btn-outline-success me-2">
            <i class="bi bi-kanban"></i> Board
        </a>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
            <i class="bi bi-plus-circle"></i> New Task
        </button>
    </div>
</div>

<!-- Project Info Card -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h5 class="card-title">{{ project.name }}</h5>
                <p class="card-text text-muted">{{ project.description or 'No description provided' }}</p>
            </div>
            <div class="col-md-4 text-end">
                <span class="badge bg-{{ 'success' if project.status == 'active' else 'secondary' }} me-2">
                    {{ project.status.title() }}
                </span>
                <span class="badge bg-{{ 'danger' if project.priority == 'critical' else 'warning' if project.priority == 'high' else 'info' if project.priority == 'medium' else 'success' }}">
                    {{ project.priority.title() }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="backlog">Backlog</option>
                    <option value="todo">To Do</option>
                    <option value="doing">Doing</option>
                    <option value="done">Done</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="typeFilter" class="form-label">Type</label>
                <select class="form-select" id="typeFilter">
                    <option value="">All Types</option>
                    <option value="task">Task</option>
                    <option value="story">Story</option>
                    <option value="bug">Bug</option>
                    <option value="epic">Epic</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="assigneeFilter" class="form-label">Assignee</label>
                <select class="form-select" id="assigneeFilter">
                    <option value="">All Assignees</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="searchInput" class="form-label">Search</label>
                <input type="text" class="form-control" id="searchInput" placeholder="Search tasks...">
            </div>
        </div>
    </div>
</div>

<!-- Spreadsheet Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="tasksTable">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 5%;">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th style="width: 10%;">Task Key</th>
                        <th style="width: 20%;">Title</th>
                        <th style="width: 8%;">Type</th>
                        <th style="width: 8%;">Status</th>
                        <th style="width: 8%;">Priority</th>
                        <th style="width: 12%;">Assignee</th>
                        <th style="width: 8%;">Due Date</th>
                        <th style="width: 5%;">Progress</th>
                        <th style="width: 8%;">Milestone</th>
                        <th style="width: 8%;">Actions</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody">
                    <!-- Tasks will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <button class="btn btn-outline-secondary" id="bulkEditBtn" disabled>
                    <i class="bi bi-pencil"></i> Bulk Edit
                </button>
                <button class="btn btn-outline-danger" id="bulkDeleteBtn" disabled>
                    <i class="bi bi-trash"></i> Delete Selected
                </button>
            </div>
            <div>
                <span class="text-muted">Showing <span id="taskCount">0</span> tasks</span>
            </div>
        </div>
    </div>
</div>

<!-- Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createTaskForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="taskTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="taskTitle" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="taskType" class="form-label">Type</label>
                                <select class="form-select" id="taskType" name="task_type">
                                    <option value="task">Task</option>
                                    <option value="story">Story</option>
                                    <option value="bug">Bug</option>
                                    <option value="epic">Epic</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="taskStatus" class="form-label">Status</label>
                                <select class="form-select" id="taskStatus" name="status">
                                    <option value="backlog">Backlog</option>
                                    <option value="todo">To Do</option>
                                    <option value="doing">Doing</option>
                                    <option value="done">Done</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="taskPriority" class="form-label">Priority</label>
                                <select class="form-select" id="taskPriority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="taskAssignee" class="form-label">Assignee</label>
                                <select class="form-select" id="taskAssignee" name="assignee_id">
                                    <option value="">Unassigned</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskMilestone" class="form-label">Milestone</label>
                                <select class="form-select" id="taskMilestone" name="milestone_id">
                                    <option value="">No Milestone</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskDueDate" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="taskDueDate" name="due_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskEstimatedHours" class="form-label">Estimated Hours</label>
                                <input type="number" class="form-control" id="taskEstimatedHours" name="estimated_hours" step="0.5" min="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="task_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="editTaskTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="editTaskTitle" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editTaskType" class="form-label">Type</label>
                                <select class="form-select" id="editTaskType" name="task_type">
                                    <option value="task">Task</option>
                                    <option value="story">Story</option>
                                    <option value="bug">Bug</option>
                                    <option value="epic">Epic</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editTaskDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editTaskStatus" class="form-label">Status</label>
                                <select class="form-select" id="editTaskStatus" name="status">
                                    <option value="backlog">Backlog</option>
                                    <option value="todo">To Do</option>
                                    <option value="doing">Doing</option>
                                    <option value="done">Done</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editTaskPriority" class="form-label">Priority</label>
                                <select class="form-select" id="editTaskPriority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editTaskAssignee" class="form-label">Assignee</label>
                                <select class="form-select" id="editTaskAssignee" name="assignee_id">
                                    <option value="">Unassigned</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskMilestone" class="form-label">Milestone</label>
                                <select class="form-select" id="editTaskMilestone" name="milestone_id">
                                    <option value="">No Milestone</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskProgress" class="form-label">Progress (%)</label>
                                <div class="d-flex align-items-center gap-3">
                                    <input type="number" class="form-control" id="editTaskProgress" name="progress_percentage" min="0" max="100" value="0" style="width: 80px;">
                                    <input type="range" class="form-range" id="editTaskProgressSlider" min="0" max="100" value="0" style="flex: 1;">
                                </div>
                                <div class="form-text">Use the slider or enter a value directly</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskDueDate" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="editTaskDueDate" name="due_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskEstimatedHours" class="form-label">Estimated Hours</label>
                                <input type="number" class="form-control" id="editTaskEstimatedHours" name="estimated_hours" step="0.5" min="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Task</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectId = {{ project.id }};
    let allTasks = [];
    let filteredTasks = [];
    let allUsers = [];
    let allMilestones = [];
    
    // Load tasks, users, and milestones
    loadTasks();
    loadUsers();
    loadMilestones();
    
    // Setup event listeners
    setupEventListeners();
    
    function loadTasks() {
        fetch(`/api/projects/${projectId}/tasks`)
            .then(response => response.json())
            .then(tasks => {
                allTasks = tasks;
                filteredTasks = tasks;
                renderTasks();
                updateTaskCount();
            })
            .catch(error => {
                console.error('Error loading tasks:', error);
                showAlert('Error loading tasks', 'danger');
            });
    }
    
    function loadUsers() {
        fetch('/api/users')
            .then(response => response.json())
            .then(users => {
                allUsers = users; // Store globally
                
                const assigneeFilter = document.getElementById('assigneeFilter');
                const taskAssignee = document.getElementById('taskAssignee');
                const editTaskAssignee = document.getElementById('editTaskAssignee');
                
                users.forEach(user => {
                    const option1 = new Option(user.full_name || user.username, user.id);
                    const option2 = new Option(user.full_name || user.username, user.id);
                    const option3 = new Option(user.full_name || user.username, user.id);
                    assigneeFilter.add(option1);
                    taskAssignee.add(option2);
                    editTaskAssignee.add(option3);
                });
            })
            .catch(error => {
                console.error('Error loading users:', error);
            });
    }
    
    function loadMilestones() {
        fetch(`/api/projects/${projectId}/milestones`)
            .then(response => response.json())
            .then(milestones => {
                allMilestones = milestones; // Store globally
                
                const taskMilestone = document.getElementById('taskMilestone');
                const editTaskMilestone = document.getElementById('editTaskMilestone');
                
                milestones.forEach(milestone => {
                    const option1 = new Option(milestone.name, milestone.id);
                    const option2 = new Option(milestone.name, milestone.id);
                    taskMilestone.add(option1);
                    editTaskMilestone.add(option2);
                });
            })
            .catch(error => {
                console.error('Error loading milestones:', error);
            });
    }
    
    function renderTasks() {
        const tbody = document.getElementById('tasksTableBody');
        tbody.innerHTML = '';
        
        filteredTasks.forEach(task => {
            const row = createTaskRow(task);
            tbody.appendChild(row);
        });
    }
    
    function createTaskRow(task) {
        const row = document.createElement('tr');
        row.dataset.taskId = task.id;
        
        const statusClass = {
            'backlog': 'secondary',
            'todo': 'primary',
            'doing': 'warning',
            'done': 'success',
            'cancelled': 'danger'
        }[task.status] || 'secondary';
        
        const priorityClass = {
            'low': 'success',
            'medium': 'info',
            'high': 'warning',
            'critical': 'danger'
        }[task.priority] || 'info';
        
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input task-checkbox" value="${task.id}">
            </td>
            <td>
                <span class="badge bg-light text-dark">${task.task_key || `TASK-${task.id}`}</span>
            </td>
            <td class="editable-cell" data-field="title" data-task-id="${task.id}">
                <span class="cell-content">${task.title}</span>
                <input type="text" class="form-control form-control-sm d-none" value="${task.title}">
            </td>
            <td class="editable-cell" data-field="task_type" data-task-id="${task.id}">
                <span class="cell-content">
                    <span class="badge bg-light text-dark">${task.task_type || 'task'}</span>
                </span>
                <select class="form-select form-select-sm d-none">
                    <option value="task" ${task.task_type === 'task' ? 'selected' : ''}>Task</option>
                    <option value="story" ${task.task_type === 'story' ? 'selected' : ''}>Story</option>
                    <option value="bug" ${task.task_type === 'bug' ? 'selected' : ''}>Bug</option>
                    <option value="epic" ${task.task_type === 'epic' ? 'selected' : ''}>Epic</option>
                </select>
            </td>
            <td class="editable-cell" data-field="status" data-task-id="${task.id}">
                <span class="cell-content">
                    <span class="badge bg-${statusClass}">${task.status}</span>
                </span>
                <select class="form-select form-select-sm d-none">
                    <option value="backlog" ${task.status === 'backlog' ? 'selected' : ''}>Backlog</option>
                    <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
                    <option value="doing" ${task.status === 'doing' ? 'selected' : ''}>Doing</option>
                    <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                    <option value="cancelled" ${task.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
            </td>
            <td class="editable-cell" data-field="priority" data-task-id="${task.id}">
                <span class="cell-content">
                    <span class="badge bg-${priorityClass}">${task.priority}</span>
                </span>
                <select class="form-select form-select-sm d-none">
                    <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                    <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
                    <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                    <option value="critical" ${task.priority === 'critical' ? 'selected' : ''}>Critical</option>
                </select>
            </td>
            <td class="editable-cell" data-field="assignee_id" data-task-id="${task.id}">
                <span class="cell-content">${task.assignee ? (task.assignee.full_name || task.assignee.username) : 'Unassigned'}</span>
                <select class="form-select form-select-sm d-none">
                    <option value="">Unassigned</option>
                    ${allUsers ? allUsers.map(user => `<option value="${user.id}" ${task.assignee_id === user.id ? 'selected' : ''}>${user.full_name || user.username}</option>`).join('') : ''}
                </select>
            </td>
            <td class="editable-cell" data-field="due_date" data-task-id="${task.id}">
                <span class="cell-content">${task.due_date ? new Date(task.due_date).toLocaleDateString() : '-'}</span>
                <input type="date" class="form-control form-control-sm d-none" value="${task.due_date || ''}">
            </td>
            <td class="editable-cell" data-field="progress_percentage" data-task-id="${task.id}">
                <span class="cell-content">
                    <div class="progress" style="height: 20px;" title="Click to edit progress">
                        <div class="progress-bar" role="progressbar" style="width: ${task.progress_percentage || 0}%">
                            ${task.progress_percentage || 0}%
                        </div>
                    </div>
                </span>
                <input type="number" class="form-control form-control-sm d-none" value="${task.progress_percentage || 0}" min="0" max="100" step="1">
            </td>
            <td class="editable-cell" data-field="milestone_id" data-task-id="${task.id}">
                <span class="cell-content">${task.milestone ? task.milestone.name : '-'}</span>
                <select class="form-select form-select-sm d-none">
                    <option value="">No Milestone</option>
                    ${allMilestones ? allMilestones.map(milestone => `<option value="${milestone.id}" ${task.milestone_id === milestone.id ? 'selected' : ''}>${milestone.name}</option>`).join('') : ''}
                </select>
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editTaskModal(${task.id})" title="Edit Task">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteTask(${task.id})" title="Delete Task">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        return row;
    }
    
    function setupEventListeners() {
        // Filters
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('typeFilter').addEventListener('change', applyFilters);
        document.getElementById('assigneeFilter').addEventListener('change', applyFilters);
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        
        // Select all checkbox
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.task-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateBulkButtons();
        });
        
        // Individual checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('task-checkbox')) {
                updateBulkButtons();
                updateSelectAll();
            }
        });
        
        // Create task form
        document.getElementById('createTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createTask();
        });
        
        // Setup inline editing and form handlers
        setupInlineEditing();
        setupFormHandlers();
    }
    
    function applyFilters() {
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const assigneeFilter = document.getElementById('assigneeFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        filteredTasks = allTasks.filter(task => {
            const matchesStatus = !statusFilter || task.status === statusFilter;
            const matchesType = !typeFilter || (task.task_type || 'task') === typeFilter;
            const matchesAssignee = !assigneeFilter || (task.assignee && task.assignee.id == assigneeFilter);
            const matchesSearch = !searchTerm || 
                task.title.toLowerCase().includes(searchTerm) ||
                (task.description && task.description.toLowerCase().includes(searchTerm));
            
            return matchesStatus && matchesType && matchesAssignee && matchesSearch;
        });
        
        renderTasks();
        updateTaskCount();
    }
    
    function updateTaskCount() {
        document.getElementById('taskCount').textContent = filteredTasks.length;
    }
    
    function updateBulkButtons() {
        const checkedBoxes = document.querySelectorAll('.task-checkbox:checked');
        const bulkEditBtn = document.getElementById('bulkEditBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        
        const hasSelection = checkedBoxes.length > 0;
        bulkEditBtn.disabled = !hasSelection;
        bulkDeleteBtn.disabled = !hasSelection;
    }
    
    function updateSelectAll() {
        const checkboxes = document.querySelectorAll('.task-checkbox');
        const selectAll = document.getElementById('selectAll');
        const checkedCount = document.querySelectorAll('.task-checkbox:checked').length;
        
        selectAll.checked = checkedCount === checkboxes.length;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }
    
    function createTask() {
        const formData = new FormData(document.getElementById('createTaskForm'));
        const taskData = Object.fromEntries(formData);
        
        fetch(`/api/projects/${projectId}/tasks`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Close modal and reload tasks
                bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
                document.getElementById('createTaskForm').reset();
                loadTasks();
                showAlert('Task created successfully!', 'success');
            } else {
                showAlert('Error creating task: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error creating task', 'danger');
        });
    }
    
    // Global functions
    window.editTask = function(taskId) {
        // This function is called when clicking on task title - open modal
        editTaskModal(taskId);
    };
    
    window.editTaskModal = function(taskId) {
        const task = allTasks.find(t => t.id === taskId);
        if (!task) {
            showAlert('Task not found', 'danger');
            return;
        }
        
        // Populate the edit form
        document.getElementById('editTaskId').value = task.id;
        document.getElementById('editTaskTitle').value = task.title;
        document.getElementById('editTaskDescription').value = task.description || '';
        document.getElementById('editTaskType').value = task.task_type || 'task';
        document.getElementById('editTaskStatus').value = task.status || 'backlog';
        document.getElementById('editTaskPriority').value = task.priority || 'medium';
        document.getElementById('editTaskAssignee').value = task.assignee_id || '';
        document.getElementById('editTaskMilestone').value = task.milestone_id || '';
        
        const progressValue = task.progress_percentage || 0;
        document.getElementById('editTaskProgress').value = progressValue;
        document.getElementById('editTaskProgressSlider').value = progressValue;
        
        document.getElementById('editTaskDueDate').value = task.due_date || '';
        document.getElementById('editTaskEstimatedHours').value = task.estimated_hours || '';
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
        modal.show();
    };
    
    window.deleteTask = function(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) {
            return;
        }
        
        fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            loadTasks();
            showAlert('Task deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deleting task: ' + error.message, 'danger');
        });
    };
    
    // Inline editing functionality
    function setupInlineEditing() {
        document.addEventListener('click', function(e) {
            if (e.target.closest('.editable-cell .cell-content')) {
                const cell = e.target.closest('.editable-cell');
                const field = cell.dataset.field;
                const taskId = cell.dataset.taskId;
                
                // Hide content, show input
                const content = cell.querySelector('.cell-content');
                const input = cell.querySelector('input, select');
                
                content.classList.add('d-none');
                input.classList.remove('d-none');
                input.focus();
                
                // Handle save on blur or enter
                const saveEdit = () => {
                    const newValue = input.value;
                    const oldValue = getCellValue(cell, field);
                    
                    if (newValue !== oldValue) {
                        updateTaskField(taskId, field, newValue);
                    }
                    
                    // Show content, hide input
                    content.classList.remove('d-none');
                    input.classList.add('d-none');
                };
                
                input.addEventListener('blur', saveEdit);
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveEdit();
                    }
                });
            }
        });
    }
    
    function getCellValue(cell, field) {
        const content = cell.querySelector('.cell-content');
        if (field === 'title') {
            return content.textContent.trim();
        } else if (field === 'due_date') {
            const dateText = content.textContent.trim();
            return dateText === '-' ? '' : dateText;
        } else if (field === 'assignee_id') {
            return content.textContent.trim() === 'Unassigned' ? '' : content.textContent.trim();
        } else if (field === 'milestone_id') {
            return content.textContent.trim() === '-' ? '' : content.textContent.trim();
        } else if (field === 'progress_percentage') {
            // Extract progress percentage from the progress bar text
            const progressText = content.textContent.trim();
            const match = progressText.match(/(\d+)%/);
            return match ? match[1] : '0';
        } else {
            // For select fields, get the selected option value
            const select = cell.querySelector('select');
            return select ? select.value : '';
        }
    }
    
    function updateTaskField(taskId, field, value) {
        const taskData = { [field]: value };
        
        fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(taskData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Refresh the display with updated data from server
            loadTasks();
            showAlert('Task updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error updating task: ' + error.message, 'danger');
        });
    }
    
    // Form submission handlers
    function setupFormHandlers() {
        // Progress slider and number input synchronization
        const progressInput = document.getElementById('editTaskProgress');
        const progressSlider = document.getElementById('editTaskProgressSlider');
        
        if (progressInput && progressSlider) {
            progressInput.addEventListener('input', function() {
                progressSlider.value = this.value;
            });
            
            progressSlider.addEventListener('input', function() {
                progressInput.value = this.value;
            });
        }
        
        // Edit task form
        document.getElementById('editTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const taskId = document.getElementById('editTaskId').value;
            const formData = new FormData(this);
            const taskData = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'task_id') continue;
                taskData[key] = value || null;
            }
            
            fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(taskData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal and reload tasks
                bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                loadTasks();
                showAlert('Task updated successfully!', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error updating task: ' + error.message, 'danger');
            });
        });
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.main-content');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}